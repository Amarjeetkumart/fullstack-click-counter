name: Deploy via AWS SSM (OIDC)

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::732132791905:role/sdf
        aws-region: ap-south-1

    - name: Deploy to EC2 using SSM
      run: |
        aws ssm send-command \
          --instance-ids "YOUR_INSTANCE_ID" \
          --document-name "AWS-RunShellScript" \
          --comment "GitHub Deployment" \
          --parameters commands='[
            "cd /home/ubuntu/fullstack-click-counter",
            "git pull origin main",
            "cd backend && npm install",
            "pm2 restart backend || pm2 start server.js --name backend",
            "cd ../frontend && npm install && npm run build",
            "sudo rm -rf /var/www/app/*",
            "sudo cp -r dist/* /var/www/app/",
            "sudo systemctl reload nginx"
          ]'
